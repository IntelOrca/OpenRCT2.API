name: CI
on: [push, pull_request]
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
    - name: Restore packages
      run: dotnet restore
    - name: Build
      run: dotnet build --configuration Release --no-restore
    - name: Test
      run: dotnet test --no-restore --verbosity normal
  build-image:
    name: Build & Push (Docker)
    needs: build-test
    runs-on: ubuntu-latest
    env:
      dockerId: ${{ secrets.dockerid }}
      dockerPassword: ${{ secrets.dockerpassword }}
      imageNameApi: openrct2/openrct2.api
      imageNameContent: openrct2/openrct2.content
      fullbranch: ${{ github.ref }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Build image (api)
      run: docker build -t "$imageNameApi" -f src/OpenRCT2.API/Dockerfile .
    - name: Build image (content)
      run: docker build -t "$imageNameContent" -f src/OpenRCT2.Content/Dockerfile .
    - name: Push image
      run: |
        branch=$(echo $fullbranch | sed 's/refs\/heads\///')
        echo "Current branch is $branch"
        if [ $branch == 'master' ]; then
            docker login -u "$dockerId" -p "$dockerPassword"
            docker push "$imageNameApi"
            docker push "$imageNameContent"
        else
            echo 'Image not pushed'
        fi
